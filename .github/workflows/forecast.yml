name: EHS Forecast

on:
  schedule:
    - cron: '0 10,22 * * *'
  workflow_dispatch:

jobs:
  forecast:
    runs-on: ubuntu-latest
    concurrency:
      group: ehs-forecast
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore last run guard
        id: cache-guard
        uses: actions/cache@v4
        with:
          path: .last_run_guard
          key: last-run-guard-${{ github.run_id }}
          restore-keys: last-run-guard-

      - name: Last run guard
        id: guard
        run: |
          mkdir -p .last_run_guard
          stamp=.last_run_guard/last_run.txt
          now=$(date -u +%s)
          if [[ -f $stamp ]]; then
            last=$(cat $stamp)
            if (( now - last < 900 )); then
              echo "should_skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo $now > $stamp
          echo "should_skip=false" >> $GITHUB_OUTPUT

      - name: Stop if guard triggered
        if: steps.guard.outputs.should_skip == 'true'
        run: |
          echo "Skipping duplicate run"
          exit 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libeccodes0 libeccodes-dev libcairo2 libpango-1.0-0 libgdk-pixbuf2.0-0 shared-mime-info

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run forecast
        env:
          PLACE_HOME: ${{ secrets.PLACE_HOME }}
          HOME_LAT: ${{ secrets.HOME_LAT }}
          HOME_LON: ${{ secrets.HOME_LON }}
          PLACE_WORK: ${{ secrets.PLACE_WORK }}
          WORK_ADDRESS: ${{ secrets.WORK_ADDRESS }}
          WORK_LAT: ${{ secrets.WORK_LAT }}
          WORK_LON: ${{ secrets.WORK_LON }}
          DAYS: ${{ secrets.DAYS }}
          PRIMARY_INGEST: ${{ secrets.PRIMARY_INGEST }}
          RSS_FALLBACK: ${{ secrets.RSS_FALLBACK }}
          CACHE_TTL_HOURS: ${{ secrets.CACHE_TTL_HOURS }}
          USER_AGENT: ${{ secrets.USER_AGENT }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
        run: |
          ehs_forecast --out out --logs-dir logs

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: forecast-${{ github.run_id }}
          path: |
            out/
            logs/
